name: "ðŸš€ Migrate Target Repository"

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Repo to migrate (org/repo)"
        required: true
      parent_version:
        description: "New version of the Parent Library"
        required: true
        default: "2.2.0-SNAPSHOT"

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Migration Toolkit
        uses: actions/checkout@v4
        with:
          # This clones your central repo into a folder named 'migration-toolkit'
          path: migration-toolkit

      - name: Checkout Target App
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repo }}
          token: ${{ secrets.PAT_TOKEN }}
          path: target-app

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      # â”€â”€ STEP 1: Update Parent Reference â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ“¦ Update Custom Parent Library"
        working-directory: target-app
        run: |
          # Updates 1.0.0 to 2.2.0-SNAPSHOT for your specific parent artifact
          perl -i -0pe "s|(<artifactId>spring-boot-mongodb-parent</artifactId>\s*<version>).*?(</version>)|\${1}2.2.0-SNAPSHOT\${2}|g" pom.xml
          echo "âœ… Parent version forced to 2.2.0-SNAPSHOT"

      # â”€â”€ STEP 2: OpenRewrite (AST Transformation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run OpenRewrite
        working-directory: target-app
        run: |
          mvn -U org.openrewrite.maven:rewrite-maven-plugin:run \
            -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:LATEST \
            -Drewrite.activeRecipes=org.openrewrite.java.spring.boot4.UpgradeSpringBoot_4_0

      # â”€â”€ STEP 3: Apply Playbook Rules (Shell logic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ“– Apply Playbook Rules"
        working-directory: target-app
        run: |
          # Reference the script from the checked-out toolkit folder
          chmod +x ../scripts/playbook-rules.sh
          ../scripts/playbook-rules.sh .

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          path: target-app
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore: migrate to Spring Boot 4 and Java 25"
          title: "ðŸš€ Migration: Spring Boot 4 / Java 25"
          body: "Updated parent to ${{ github.event.inputs.parent_version }} and applied playbook rules from migration-playbook.md."