name: "ðŸš€ Migrate Target Repository"

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Repo to migrate (org/repo)"
        required: true
      parent_version:
        description: "New version of the Parent Library"
        required: true
        default: "2.0.0" # Version of your already-migrated parent

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Central Hub (Playbook)
        uses: actions/checkout@v4
        with:
          path: hub

      - name: Checkout Target App
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repo }}
          token: ${{ secrets.PAT_TOKEN }} # Needs 'repo' scope
          path: target-app

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

     - name: "ðŸ“¦ Update Custom Parent Library"
        working-directory: target-app
        run: |
          # Replaces the version for your specific parent artifactId
          # Works for both 1.0.0 and 1.0.0-SNAPSHOT to 2.2.0-SNAPSHOT
          perl -i -0pe "s|(<artifactId>spring-boot-mongodb-parent</artifactId>\s*<version>).*?(</version>)|\${1}2.2.0-SNAPSHOT\${2}|g" pom.xml
          
          echo "  âœ” Updated Parent to 2.2.0-SNAPSHOT"
          
          # Optional: Also update the Java version property if it's explicitly defined in the child
          sed -i 's/<java.version>21<\/java.version>/<java.version>25<\/java.version>/g' pom.xml || true

      # â”€â”€ STEP 2: OpenRewrite (AST Transformation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run OpenRewrite
        working-directory: target-app
        run: |
          mvn -U org.openrewrite.maven:rewrite-maven-plugin:run \
            -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:LATEST \
            -Drewrite.activeRecipes=org.openrewrite.java.spring.boot4.UpgradeSpringBoot_4_0

      # â”€â”€ STEP 3: Apply Playbook Rules (Shell logic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ“– Apply Playbook Rules"
        working-directory: target-repo
        run: |
          # 1. Make the central script executable
          # Note: The path depends on where you checked out your migration-toolkit
          chmod +x ../migration-toolkit/scripts/playbook-rules.sh
          
          # 2. Run the script. This script handles:
          #    - @MockBean -> @MockitoBean conversion
          #    - Import statement updates (Critical!)
          #    - Jackson and Security property renames
          ../migration-toolkit/scripts/playbook-rules.sh .

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          path: target-app
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore: migrate to Spring Boot 4 and Java 25"
          title: "ðŸš€ Migration: Spring Boot 4 / Java 25"
          body: "Updated parent to ${{ github.event.inputs.parent_version }} and applied playbook rules."